<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopnow</title>
    <link rel="icon" type = "image/x-icon" href="../../assets/icon/shopping-bag.png">
    <link rel="stylesheet" href="../../assets/css/payment.css">
</head>
<body>
    <header> 
        <div class="logo">
        <img src="../../assets/icon/shopping-bag.png" alt="shopping-bag" width="40px" height="40px">
        <a href="../../index.html"><h5 class="logo-name"><b>Shopnow</b></h5></a>
   <div class="tracking">
    <img src="../../assets/icon/icons8-checkmark-48.png" alt="" width="40px"m height="40px">
    <img src="../../assets/icon/icons8-circled-2-48.png" alt="" width="40px"m height="40px">
   </div>
    </div>
</header>
<main>
    <div class="checkout">
        <p class="address">Delivery address</p>
        <div class="add_container">
            <div id="person_info"><p id="add_person_name">Sasikumar</p><p id="add_number">6374523686</p></div>
            <div id="location_info"><p id="location">ST Couriers, IT Corridor, Lakshman Nagar, Perungudi, Chennai, Tamil Nadu -</p><p id="add_pincode">600096</p></div>
        </div>
        <!-- product detatil -->
        <p class="product">Product detail</p>
<div class="main_container">
    <div class="pro_container">

        <img src="https://iili.io/HVTwSyl.webp" alt="apple" id="mob_img">

    <div class="pro_info">
        <p id="mob_name">APPLE iPhone 14</p>
        <div id="rate">
        <p id="mob_price">₹39,999</p>
        <p >Qty  </p><p class="mob_qty">0</p>
        </div>
    </div>
 </div>
</div>
         <!-- payment method -->
         <p class="product">Payment options</p>
         <form action="" id="forms">
            <div class="payment">
                <div class="radio radio-1" ><input type="radio" class="radio_btn" name="radio" data-keyword = "UPI" required><img src="../../assets/icon/UPI.gif" alt="" width="30px" height="30px"><p>UPI</p></div>
                <!-- <form class="mini_form"> -->
                <div class="upi_container">
                <label class="custom-field one">
                
                    <input type="text" placeholder=" " id="upi_input" name="username" required/>
                    <span class="placeholder">Enter UPI ID</span>
                </label>
                <button class="button-39" type="submit">PAY</button>
                
                  <div class="success"></div>
            </div>
                <!-- </form> -->
                <div class="radio radio-3"><input type="radio" class="radio_btn" name="radio" data-keyword = "Credit/Debit/Atm card" required><img src="../../assets/icon/icons8-credit-card-64.png" alt="" width="30px" height="30px"><p>Credit/Debit/Atm card </p></div>
                <div class="card_container">
                    <label class="custom-field one">
                        <input type="text" placeholder=" " id="card_input" name="username" required/>
                        <span class="placeholder">Enter Card Number</span>
                      </label>
                      <button class="button-39" type="submit">PAY</button>
                      <div id="date_label"><P>Expiry date : </P><input type="date" value="2017-01-01" min="2005-01-01" max="2019-01-01" id="date_input" required><input type="text" id="cvv" pname="username" laceholder="CVV" required></div>
                     <div class="success"></div>
                      
                </div>
                <!-- <div class="radio radio-4"><input type="radio" class="radio_btn" name="radio" data-keyword = "Net banking" required><img src="../../assets/icon/icons8-merchant-account-50.png" alt="" width="30px" height="30px"><p>Net banking</p></div> -->
                <div class="radio radio-5"><input type="radio" class="radio_btn" name="radio" data-keyword = "Cash on delivery" required><img src="../../assets/icon/icons8-cash-on-delivery-66.png" alt="" width="30px" height="30px"><p>Cash on delivery</p></div>
            </div>
            <button class="btn" id="order" type="submit">CONFIRM ORDER</button>
            
         </form>
    </div>
    <div class="summary_container navigation">
        <h2>Product detail</h2>
        <!-- <hr id="hr"> -->
        <div class="pr_price"><p id="qty">Product Price</p><p class="price">₹34,999</p></div> 
        <div class="pr_price" ><p>Delivery charges</p><p id="deliver">FREE</p></div>
        <hr id="hr_2">
        <div class="pr_price" id="total"><p>Order total</p><p class="price">₹34,999</p></div> 
     </div>
     <!-- <div class="container">
        <img src="../../assets/icon/check.gif" alt="" width="140px" height="100px">
        <h2 id="thanks">Thank you for your purchase</h2>
        <p><b>We recived your purchase request <br>we'll be in touch shortly</b></p>
    </div> -->
</main> 
<script>
    //event for form submit
    const form = document.getElementById("forms")
    form.addEventListener("submit",function (e) {
        e.preventDefault();
        getData();
        paymentSuccess();
    })

    // const minform = document.querySelector(".mini_form")
    // console.log(minform);
    // minform.addEventListener("submit",function (f) {
    //     f.preventDefault();
        
    // })

//get address array from local storage
 const address = JSON.parse(localStorage.getItem("address"))
 //find the object which selected by user 
 const address_obj = address.find(function (obj) {
    if (obj["select"] == true) {
        return true
    }
    else{
        return false
    }
 })

 //get the address container elements
 const address_name = document.getElementById("add_person_name")
 const address_num = document.getElementById("add_number")
 const address_info = document.getElementById("location")
 const address_pincode = document.getElementById("add_pincode")

 //set the finded value in that container
 address_name.innerText = address_obj["name"]
 address_num.innerText = address_obj["phone_number"]
 address_info.innerText = address_obj["house_number"]+", "+address_obj["area"]+", "+address_obj["landmark"]+" -"
 address_pincode.innerText = address_obj["pincode"]

 const url = window.location.search
 const search = new URLSearchParams(url)
 const product_id = search.get("id")
 //store the qty and total amount of mobile
let summary_info = product_id.split(",")
let mobile_qty = document.getElementById("qty")
let mobile_price = document.querySelectorAll(".price")

//cart paramms contains two numbers with "," special character so it's for verify 
if (summary_info.length === 3) {


mobile_qty.innerText = `Price (${summary_info[0]} items)`
mobile_price[0].innerText = "₹"+summary_info[1]
mobile_price[1].innerText = "₹"+summary_info[1]

    let main_div = document.querySelector(".main_container")
    main_div.innerHTML = " "

    const cart_arr = JSON.parse(localStorage.getItem("cart"))
    const profile = JSON.parse(localStorage.getItem("profile"))
    const username = profile["user_id"]

const cart_obj = cart_arr.filter(function (obj) {
    if (username === obj["user_id"] && obj["cart"] !== false) {
        return true
    }
    else{
        return false
    }
})
//console.log(cart_obj);
//geting products array for match with cart objects
const product_arr = JSON.parse(localStorage.getItem("products"))
//pushing finded arraysin this array
const product_array = []
for(j = 0; j < cart_obj.length;j++ ){

for(i = 0; i < product_arr.length;i++){
if(cart_obj[j]["product_id"] ===  product_arr[i]["user_id"]){
    product_array.push(product_arr[i])

}
}
} 

let pr_container = ""

for (let i = 0; i < product_array.length; i++) {

    pr_container += `<div class="pro_container">
<img src="${product_array[i]["product_img_1"]}" alt="apple" id="mob_img">
<div class="pro_info">
<p id="mob_name">${product_array[i]["product_name"]}</p>
<div id="rate">
<p id="mob_price">${"₹ "+ parseFloat(product_array[i]["product_price"].slice(1)) * parseFloat(cart_obj[i]["quantity"])}</p>
<p data-keyword="${product_array[i]["user_id"]}" class="qty_para">Qty  </p><p class="mob_qty">${cart_obj[i]["quantity"]}</p>
</div></div></div>` 
    
}

main_div.innerHTML = pr_container

}


 const pr_array = JSON.parse(localStorage.getItem("products"))
//get the elements from product container
const product_img = document.getElementById("mob_img")
 const product_name = document.getElementById("mob_name")
 const product_price = document.getElementById("mob_price")
 const product_qty = document.querySelector(".mob_qty")
if (summary_info.length == 2) {
     
 //find the specific object from the products array
 const pr_obj = pr_array.find(function (obj) {
    if (summary_info[0] == obj["user_id"]+"") {
        return true
    }
    else{
        return false
    }
 })
 console.log(pr_obj);


 //set the values to product container
 product_img.src = pr_obj["product_img_1"]
 product_name.innerText = pr_obj["product_name"]
 product_price.innerText = pr_obj["product_price"]
 product_qty.innerText = pr_obj["quantity"]

 //set the value in total container
 const price = document.querySelectorAll(".price")
 price[0].innerText = pr_obj["product_price"]
price[1].innerText = pr_obj["product_price"]
}
function getData() {
     //get product details array from local storage
 const product_array = JSON.parse(localStorage.getItem("products"))
 
 //get users id for idnefiying
 const user_array = JSON.parse(localStorage.getItem("profile"))
 
 const order_btn = document.getElementById("order")
 
 order_btn.addEventListener("click",function(){
 
 const radio_btn = document.querySelectorAll(".radio_btn")
 const upi_input = document.querySelector(".upi_container")
 //store the payment method
 let payment_method = ""

//  for loop for finding checked btn
 for(let j = 0;j < radio_btn.length;j++){

    radio_btn[j].addEventListener("click",function () {
        if (radio_btn[j].checked === true) {
          payment_method =  radio_btn[j].dataset.keyword
          
     }        
    })
 }
 
     let order_arr = JSON.parse(localStorage.getItem("orders"))?JSON.parse(localStorage.getItem("orders")):[]
 
    if (summary_info.length == 2) {
        let qty_digit = document.querySelector(".mob_qty")
        let quantity = qty_digit.innerHTML

        let uid = Math.floor(Math.random() * 1000)
     order_arr.push(
         {
 
             "order_id" : uid,
             "user_id" : user_array["user_id"],
             "product_id" : summary_info[0],
             "payment_method" : payment_method,
             "address_id" : address_obj["id"],
             "quantity" : quantity,
             "shop_id" : summary_info[1]
         }
     )
    }
    else{

        let qty = document.querySelectorAll(".qty_para")
        let qty_digit = document.querySelectorAll(".mob_qty")


        for (let j = 0; j < qty.length; j++) {

            let product_id = qty[j].dataset.keyword
            let quantity = qty_digit[j].innerHTML
            let uid = Math.floor(Math.random() * 1000)
            
     order_arr.push(
         {
 
             "order_id" : uid,
             "user_id" : user_array["user_id"],
             "product_id" : product_id,
             "payment_method" : payment_method,
             "address_id" : address_obj["id"],
             "quantity" : quantity,
             "shop_id" : summary_info[2]
         }
     )
            
        }

        let cart_array = JSON.parse(localStorage.getItem("cart"))
let updated_cart = cart_array.filter(function (obj) {
    if (user_array["user_id"] === obj["user_id"]) {
                return false
            }
            else{
                return true
            }    
})




        localStorage.setItem("cart",JSON.stringify(updated_cart))

    }

    window.location.href = "order.html"
 
     localStorage.setItem("orders",JSON.stringify(order_arr));
  
    

    
 })
 
 
}
const radio_btn = document.querySelectorAll(".radio_btn")
 const upi_input = document.querySelector(".upi_container")
 const card_input = document.querySelector(".card_container")
 const upi_inp = document.getElementById("upi_input")
        const card_inp = document.getElementById("card_input")
        const date_inp = document.getElementById("date_input")
        const cvv_inp = document.getElementById("cvv")
 //store the payment method
 let payment_method = ""

//  for loop for finding checked btn
 for(let j = 0;j < radio_btn.length;j++){

    radio_btn[j].addEventListener("click",function () {
        if (radio_btn[j].checked === true) {
          payment_method =  radio_btn[j].dataset.keyword

          if (payment_method === "UPI") {
            upi_input.style.display = "block"
            card_input.style.display = "none"
          }
          if (payment_method === "Credit/Debit/Atm card") {
            upi_input.style.display = "none"
            card_input.style.display = "block"
          }
          if (payment_method === "Cash on delivery") {
            upi_input.style.display = "none"
            card_input.style.display = "none"
          }

          if (card_input.style.display === "block") {
            upi_inp.removeAttribute("required")
            card_inp.setAttribute("required","")
            date_inp.setAttribute("required","")
            cvv_inp.setAttribute("required","")

        }
        if (upi_input.style.display === "block") {
            upi_inp.setAttribute("required","")
            card_inp.removeAttribute("required")
            date_inp.removeAttribute("required")
            cvv_inp.removeAttribute("required")
        }
          
     }
     if (radio_btn[2].checked === true) {
        upi_inp.removeAttribute("required")
        card_inp.removeAttribute("required")
        date_inp.removeAttribute("required")
        cvv_inp.removeAttribute("required")
     }        
    })


 }

 const payment_done_alert = document.querySelectorAll(".success")
 const pay_btn = document.querySelectorAll(".button-39")



    // for (let j = 0; j < pay_btn.length; j++) {
    
    // pay_btn[j].addEventListener("click",function(){





        
function paymentSuccess() {

    if (upi_input.style.display === "block") {
        payment_done_alert[0].innerHTML = "<p id=payment_done>Payment was successful</p>"
    }
    if (card_input.style.display === "block") {
        payment_done_alert[1].innerHTML = "<p id=payment_done>Payment was successful</p>"
    }

    }

    if(summary_info.length === 2){
  pr_array.find(function (obj) {
    
    
    if (summary_info[0] === obj["user_id"]+"") {
      mobile_qty.innerText = `Price (${obj["quantity"]} items)`
      mobile_price[0].innerText = "₹"+parseFloat(obj["quantity"]) * parseFloat(obj["product_price"].slice(1))
      mobile_price[1].innerText = "₹"+parseFloat(obj["quantity"]) * parseFloat(obj["product_price"].slice(1))
      product_price.innerText = "₹"+parseFloat(obj["quantity"]) * parseFloat(obj["product_price"].slice(1))
    }
  
  })
}
    // })
//  }







</script>  
</body>
</html>